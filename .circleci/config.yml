version: 2
jobs:
  build:
    docker:
      - image: parity/rust-parity-ethereum-build:xenial
    steps:
      - run:
          command: |
            git clone https://gitlab.parity.io/parity/parity-ethereum.git/ .
            git submodule update --init --recursive

            FEATURES="json-tests,ci-skip-tests"
            OPTIONS="--release"
            #use nproc `linux only
            THREADS=$(nproc)

            time cargo test $OPTIONS --no-run --features "$FEATURES" --locked --all --target $CARGO_TARGET -- --test-threads $THREADS

  build_test:
    docker:
      - image: parity/rust-parity-ethereum-build:xenial
    steps:
      - run:
          command: |
            git clone https://gitlab.parity.io/parity/parity-ethereum.git/ .
            git submodule update --init --recursive

            FEATURES="json-tests,ci-skip-tests"
            OPTIONS="--release"
            #use nproc `linux only
            THREADS=$(nproc)

            time cargo test $OPTIONS --features "$FEATURES" --locked --all --target $CARGO_TARGET -- --test-threads $THREADS

workflows:
  version: 2
  circle_cahcce_test:
    jobs:
      - build
      - build_test
